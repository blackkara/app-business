<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/geo-location/geo-location.html">
<link rel="import" href="/bower_components/core-ajax/core-ajax.html">

<!-- 
    @url: sends data to specified url
    @period: sends data to specified url every specified period
    @service: starts or stops service
-->
<polymer-element name="phone-business" constructor="PhoneBusiness"
    attributes="url period service">
    
    <template>
        
        <geo-location highAccuracy="true"></geo-location>
        
        <core-ajax id="ajax" url={{url}} reponse="{{ajaxResponse}}" error="{{ajaxError}}"></core-ajax>

    </template>
   
    <script>

        Polymer({
            
           /**
            * logging flag, @default false
            */
            log: true,
            
           /**
            * logging tag
            */
            tag: 'phone-business',
              
           /**
            * Device id
            * @default null
            */
            deviceId: null,
            
           /**
            * sets deviceId
            */
            setDeviceId: function(id){
                this.deviceId = id;
            },
            
           /**
            * remote server url, 'core-ajax' uses
            */
            url: '',
            
           /**
            * 'task' uses to send data to server.
            *
            * It might send data with specified period
            * forexample, in every 5000 miliseconds
            *
            * Or, might send data as soon as 
            * geo-location obtaines
            *
            * @default 3000 miliseconds
            */
            period: 3000,
            
           /**
            * Interval 
            * when service started, will be initialized
            * when service stopped, will be cleared
            */
            task: null,
            
           /** 
            * @lastUpdate, Device last update time
            * When device gets location, updates lastUpdate
            */
            lastUpdate: null,
            
           /** 
            * @lastLat, Device last latitude
            * When device gets latitude, updates lastLat
            */
            lastLat: null,
            
           /** 
            * @latLng, Device last longitude
            * When device gets longitude, updates lastLng 
            */
            lastLng: null,
            
           /**
            * For each sentence, phone-business assignes id
            */
            nextSentenceId: 1,
            
           /**
            * uses nextSentenceId property
            * increases +1
            */
            ID: function(){
                return 'SENTENCE_' + (this.nextSentenceId++);
            },
            
           /**
            * status of service
            * startService and stopService change
            * @default false
            */
            serviceStatus: false,
            
           /** 
            * Listens to service property, started or not.
            */
            serviceChanged: function(e){
                
                var self = this;
                
                var status = self.service_;
                
                var gps = self.shadowRoot.querySelector('geo-location');
                
                var ajx = self.shadowRoot.querySelector('core-ajax');
                    
                ajx.url = self.url_;
                
                if(status){
                    
                    // Listen location
                    gps.watchPos = true;
                    
                    gps.addEventListener('geo-response', function(){
                        
                        if(self.log) console.log(self.tag + ': location updated');
                    
                        self.lastUpdate = new Date();
                        
                        self.lastLat = this.latitude.toFixed(8);
                        
                        self.lastLng = this.longitude.toFixed(8);
                        
                        if(self.period === 'location'){
                            
                            ajx.params = JSON.stringify({
                                sentenceId: self.ID(),
                                deviceId: self.deviceId,
                                latitude: self.lastLat,
                                longitude: self.lastLng,
                                updatetime: self.lastUpdate
                            });
                            
                            self.fire('on-sentence', ajx.params);
                            
                            ajx.go();
                            
                        }
                        
                    });
                
                    if(!isNaN(self.period) && self.period >0){
                        
                        self.task = setInterval(function(){
                    
                            ajx.params = JSON.stringify({
                                sentenceId: self.ID(),
                                deviceId: self.deviceId,
                                latitude: self.lastLat,
                                longitude: self.lastLng,
                                updatetime: self.lastUpdate
                            });
                        
                            self.fire('on-sentence', ajx.params);
                        
                            ajx.go();
                        
                            if(self.log) console.log(self.tag + ': Task is working... ' + ajx.params);
                    
                        }, self.period);
                    }
                    
                    if(self.log) console.log(self.tag + ': Service has started');
                }
                
                else {
                    
                    if(self.log) console.log(self.tag + ': Service has stopped');
                    
                    if(self.task)
                        clearInterval(self.task);
                    
                    gps.watchPos = false;
                    ajx.abort();
                    
                }
            },
            

            
            ajaxResponse: function(e){
                
                if(self.log) console.log(self.tag + ': Response from server');
                //if(self.log) console.log(e);
                
            },
            
            ajaxError: function(e){
                
                if(self.log) console.log(self.tag + ': Error occured');
                //if(self.log) console.log(e);
            },

            ready: function(){
                
                if(self.log) console.log(this.tag + ': ready!' 
                    +' url ' + self.url
                    +' period ' + self.period);
            }
      
        });
    </script>
    
</polymer-element>